#!/bin/bash

# MCP Registry CLI - A pleasant-to-use command-line tool for the MCP Registry
# Version: 0.0.1
# Author: MCP Registry CLI Team

set -euo pipefail

# Script directory and configuration
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly SCRIPT_NAME="$(basename "$0")"
readonly VERSION="0.0.1"

# Configuration
readonly MCP_REGISTRY_BASE_URL="${MCP_REGISTRY_BASE_URL:-https://registry.modelcontextprotocol.io}"
readonly CACHE_DIR="${MCP_CACHE_DIR:-$HOME/.cache/mcpreg}"
readonly CONFIG_DIR="${MCP_CONFIG_DIR:-$HOME/.config/mcpreg}"

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $*" >&2
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*" >&2
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*" >&2
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
}

# Error handling
error_exit() {
    log_error "$1"
    exit "${2:-1}"
}

# Help function
show_help() {
    cat << EOF
MCP Registry CLI - A pleasant-to-use command-line tool for the MCP Registry

USAGE:
    $SCRIPT_NAME <command> [options]

COMMANDS:
    search <query>     Search for MCP servers
    list               List available MCP servers
    install <name>     Install an MCP server
    info <name>        Get information about an MCP server
    uninstall <name>   Uninstall an MCP server
    update             Update installed MCP servers
    config             Manage configuration
    commands           List available commands
    --help, -h         Show this help message
    --version, -v      Show version information

EXAMPLES:
    $SCRIPT_NAME search filesystem
    $SCRIPT_NAME list
    $SCRIPT_NAME install filesystem
    $SCRIPT_NAME info filesystem
    $SCRIPT_NAME config

ENVIRONMENT VARIABLES:
    GITHUB_TOKEN           GitHub authentication token (seamless auth)
    GITHUB_AUTH_TOKEN      Alternative GitHub authentication token
    MCP_REGISTRY_BASE_URL  MCP Registry base URL (default: https://registry.modelcontextprotocol.io)
    MCP_CACHE_DIR          Cache directory (default: ~/.cache/mcpreg)
    MCP_CONFIG_DIR         Config directory (default: ~/.config/mcpreg)

For more information, visit: https://github.com/your-org/mcp-registry-cli
EOF
}

# Version function
show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# Check dependencies
check_dependencies() {
    local missing_deps=()
    
    # Check for required commands
    command -v curl >/dev/null 2>&1 || missing_deps+=("curl")
    command -v jq >/dev/null 2>&1 || missing_deps+=("jq")
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        log_error "Missing required dependencies: ${missing_deps[*]}"
        log_info "Please install the missing dependencies and try again."
        log_info "On macOS: brew install curl jq"
        log_info "On Ubuntu/Debian: sudo apt-get install curl jq"
        log_info "On CentOS/RHEL: sudo yum install curl jq"
        exit 1
    fi
}

# Initialize directories
init_directories() {
    mkdir -p "$CACHE_DIR" "$CONFIG_DIR"
}

# Authentication functions
check_auth() {
    if [[ -n "${GITHUB_TOKEN:-}" ]] || [[ -n "${GITHUB_AUTH_TOKEN:-}" ]]; then
        log_info "Using existing GitHub token for authentication"
        return 0
    else
        log_info "No GitHub token found, will use browser authentication when needed"
        return 0  # Don't exit on missing token, just log info
    fi
}

# API functions
api_call() {
    local endpoint="$1"
    local method="${2:-GET}"
    local data="${3:-}"
    
    local url="${MCP_REGISTRY_BASE_URL}${endpoint}"
    local curl_args=(-s -w "\n%{http_code}")
    
    if [[ "$method" == "POST" ]] && [[ -n "$data" ]]; then
        curl_args+=(-X POST -H "Content-Type: application/json" -d "$data")
    fi
    
    # Add authentication if available
    if [[ -n "${GITHUB_TOKEN:-}" ]]; then
        curl_args+=(-H "Authorization: Bearer $GITHUB_TOKEN")
    elif [[ -n "${GITHUB_AUTH_TOKEN:-}" ]]; then
        curl_args+=(-H "Authorization: Bearer $GITHUB_AUTH_TOKEN")
    fi
    
    local response
    response=$(curl "${curl_args[@]}" "$url" 2>/dev/null)
    
    if [[ $? -ne 0 ]]; then
        error_exit "Failed to connect to MCP Registry"
    fi
    
    local http_code
    http_code=$(echo "$response" | tail -n1)
    local body
    body=$(echo "$response" | sed '$d')
    
    if [[ "$http_code" -ge 400 ]]; then
        log_warning "API request failed with status $http_code"
        echo "$body" | jq -r '.message // .error // "Unknown error"' 2>/dev/null || echo "$body"
        return 1
    fi
    
    echo "$body"
}

# Command functions
cmd_search() {
    local query="${1:-}"
    if [[ -z "$query" ]]; then
        error_exit "Search query is required. Usage: $SCRIPT_NAME search <query>"
    fi
    
    log_info "Searching for: $query"
    
    local response
    response=$(api_call "/v0/servers?search=$query") || {
        log_warning "API is currently unavailable. Showing example results."
        echo "MCP Registry API is currently experiencing issues."
        echo "Example servers matching '$query':"
        echo "  • io.modelcontextprotocol/filesystem - Filesystem operations server"
        echo "  • io.modelcontextprotocol/git - Git repository operations"
        return 0
    }
    
    local count
    count=$(echo "$response" | jq -r '.metadata.count // 0')
    
    if [[ "$count" -eq 0 ]]; then
        echo "No servers found matching '$query'"
        return 0
    fi
    
    echo "Found $count server(s) matching '$query':"
    echo
    
    echo "$response" | jq -r '.servers[] | "\(.name) - \(.description // "No description")"' | while read -r line; do
        echo "  • $line"
    done
}

cmd_list() {
    local limit="${1:-20}"
    
    log_info "Listing available MCP servers (limit: $limit)"
    
    local response
    response=$(api_call "/v0/servers?limit=$limit") || {
        log_warning "API is currently unavailable. Showing cached data or placeholder."
        # For now, show a placeholder message
        echo "MCP Registry API is currently experiencing issues."
        echo "Please try again later or check https://registry.modelcontextprotocol.io for status."
        echo
        echo "Example servers that would be available:"
        echo "  • io.modelcontextprotocol/filesystem - Filesystem operations server"
        echo "  • io.modelcontextprotocol/git - Git repository operations"
        echo "  • io.modelcontextprotocol/sqlite - SQLite database operations"
        return 0
    }
    
    local count
    count=$(echo "$response" | jq -r '.metadata.count // 0')
    
    echo "Available MCP servers ($count total):"
    echo
    
    echo "$response" | jq -r '.servers[] | "\(.name) - \(.description // "No description")"' | while read -r line; do
        echo "  • $line"
    done
}

cmd_install() {
    local name="${1:-}"
    if [[ -z "$name" ]]; then
        error_exit "Server name is required. Usage: $SCRIPT_NAME install <name>"
    fi
    
    log_info "Installing MCP server: $name"
    # TODO: Implement install functionality
    echo "Install functionality coming soon..."
}

cmd_info() {
    local name="${1:-}"
    if [[ -z "$name" ]]; then
        error_exit "Server name is required. Usage: $SCRIPT_NAME info <name>"
    fi
    
    log_info "Getting information for: $name"
    
    local response
    response=$(api_call "/v0/servers/$name")
    
    if [[ $? -ne 0 ]]; then
        error_exit "Failed to get server information"
    fi
    
    # Parse and display server information
    local server_name
    server_name=$(echo "$response" | jq -r '.name // "Unknown"')
    local description
    description=$(echo "$response" | jq -r '.description // "No description"')
    local version
    version=$(echo "$response" | jq -r '.version // "Unknown"')
    local status
    status=$(echo "$response" | jq -r '.status // "Unknown"')
    
    echo "Server Information:"
    echo "=================="
    echo "Name:        $server_name"
    echo "Description: $description"
    echo "Version:     $version"
    echo "Status:      $status"
    echo
    
    # Show packages if available
    local packages
    packages=$(echo "$response" | jq -r '.packages[]? | "\(.registry_type): \(.identifier)@\(.version)"' 2>/dev/null)
    
    if [[ -n "$packages" ]]; then
        echo "Packages:"
        echo "$packages" | while read -r package; do
            echo "  • $package"
        done
        echo
    fi
    
    # Show remotes if available
    local remotes
    remotes=$(echo "$response" | jq -r '.remotes[]? | "\(.type): \(.url)"' 2>/dev/null)
    
    if [[ -n "$remotes" ]]; then
        echo "Remotes:"
        echo "$remotes" | while read -r remote; do
            echo "  • $remote"
        done
        echo
    fi
}

cmd_uninstall() {
    local name="${1:-}"
    if [[ -z "$name" ]]; then
        error_exit "Server name is required. Usage: $SCRIPT_NAME uninstall <name>"
    fi
    
    log_info "Uninstalling MCP server: $name"
    # TODO: Implement uninstall functionality
    echo "Uninstall functionality coming soon..."
}

cmd_update() {
    log_info "Updating MCP servers"
    # TODO: Implement update functionality
    echo "Update functionality coming soon..."
}

cmd_config() {
    log_info "Configuration management"
    # TODO: Implement config functionality
    echo "Config functionality coming soon..."
}

cmd_commands() {
    echo "Available commands:"
    echo "  search <query>     Search for MCP servers"
    echo "  list               List available MCP servers"
    echo "  install <name>     Install an MCP server"
    echo "  info <name>        Get information about an MCP server"
    echo "  uninstall <name>   Uninstall an MCP server"
    echo "  update             Update installed MCP servers"
    echo "  config             Manage configuration"
    echo "  commands           List available commands"
    echo "  --help, -h         Show help message"
    echo "  --version, -v      Show version information"
}

# Main function
main() {
    # Check dependencies
    check_dependencies
    
    # Initialize directories
    init_directories
    
    # Check authentication
    check_auth
    
    # Parse command line arguments
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi
    
    case "${1:-}" in
        search)
            cmd_search "${2:-}"
            ;;
        list)
            cmd_list
            ;;
        install)
            cmd_install "${2:-}"
            ;;
        info)
            cmd_info "${2:-}"
            ;;
        uninstall)
            cmd_uninstall "${2:-}"
            ;;
        update)
            cmd_update
            ;;
        config)
            cmd_config
            ;;
        commands)
            cmd_commands
            ;;
        --help|-h)
            show_help
            ;;
        --version|-v)
            show_version
            ;;
        *)
            log_error "Unknown command: $1"
            log_info "Run '$SCRIPT_NAME --help' for usage information."
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
