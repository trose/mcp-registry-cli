#!/bin/bash

# MCP Registry CLI - A pleasant-to-use command-line tool for the MCP Registry
# Version: 0.0.1
# Author: MCP Registry CLI Team

set -euo pipefail

# Script directory and configuration
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly SCRIPT_NAME="$(basename "$0")"
readonly VERSION="0.0.1"

# Configuration
readonly MCP_REGISTRY_BASE_URL="${MCP_REGISTRY_BASE_URL:-https://registry.modelcontextprotocol.io}"
readonly CACHE_DIR="${MCP_CACHE_DIR:-$HOME/.cache/mcpreg}"
readonly CONFIG_DIR="${MCP_CONFIG_DIR:-$HOME/.config/mcpreg}"

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $*" >&2
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*" >&2
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*" >&2
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*" >&2
}

# Error handling
error_exit() {
    log_error "$1"
    exit "${2:-1}"
}

# Help function
show_help() {
    cat << EOF
MCP Registry CLI - A pleasant-to-use command-line tool for the MCP Registry

USAGE:
    $SCRIPT_NAME <command> [options]

COMMANDS:
    search <query>     Search for MCP servers
    list               List available MCP servers
    install <name>     Install an MCP server
    info <name>        Get information about an MCP server
    uninstall <name>   Uninstall an MCP server
    update             Update installed MCP servers
    config             Manage configuration
    commands           List available commands
    --help, -h         Show this help message
    --version, -v      Show version information

EXAMPLES:
    $SCRIPT_NAME search filesystem
    $SCRIPT_NAME list
    $SCRIPT_NAME install filesystem
    $SCRIPT_NAME info filesystem
    $SCRIPT_NAME config

ENVIRONMENT VARIABLES:
    GITHUB_TOKEN           GitHub authentication token (seamless auth)
    GITHUB_AUTH_TOKEN      Alternative GitHub authentication token
    MCP_REGISTRY_BASE_URL  MCP Registry base URL (default: https://registry.modelcontextprotocol.io)
    MCP_CACHE_DIR          Cache directory (default: ~/.cache/mcpreg)
    MCP_CONFIG_DIR         Config directory (default: ~/.config/mcpreg)

For more information, visit: https://github.com/your-org/mcp-registry-cli
EOF
}

# Version function
show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

# Check dependencies
check_dependencies() {
    local missing_deps=()
    
    # Check for required commands
    command -v curl >/dev/null 2>&1 || missing_deps+=("curl")
    command -v jq >/dev/null 2>&1 || missing_deps+=("jq")
    
    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        log_error "Missing required dependencies: ${missing_deps[*]}"
        log_info "Please install the missing dependencies and try again."
        log_info "On macOS: brew install curl jq"
        log_info "On Ubuntu/Debian: sudo apt-get install curl jq"
        log_info "On CentOS/RHEL: sudo yum install curl jq"
        exit 1
    fi
}

# Initialize directories
init_directories() {
    mkdir -p "$CACHE_DIR" "$CONFIG_DIR"
}

# Authentication functions
check_auth() {
    if [[ -n "${GITHUB_TOKEN:-}" ]] || [[ -n "${GITHUB_AUTH_TOKEN:-}" ]]; then
        log_info "Using existing GitHub token for authentication"
        return 0
    else
        log_info "No GitHub token found, will use browser authentication when needed"
        return 0  # Don't exit on missing token, just log info
    fi
}

# Placeholder command functions
cmd_search() {
    local query="${1:-}"
    if [[ -z "$query" ]]; then
        error_exit "Search query is required. Usage: $SCRIPT_NAME search <query>"
    fi
    
    log_info "Searching for: $query"
    # TODO: Implement search functionality
    echo "Search functionality coming soon..."
}

cmd_list() {
    log_info "Listing available MCP servers"
    # TODO: Implement list functionality
    echo "List functionality coming soon..."
}

cmd_install() {
    local name="${1:-}"
    if [[ -z "$name" ]]; then
        error_exit "Server name is required. Usage: $SCRIPT_NAME install <name>"
    fi
    
    log_info "Installing MCP server: $name"
    # TODO: Implement install functionality
    echo "Install functionality coming soon..."
}

cmd_info() {
    local name="${1:-}"
    if [[ -z "$name" ]]; then
        error_exit "Server name is required. Usage: $SCRIPT_NAME info <name>"
    fi
    
    log_info "Getting information for: $name"
    # TODO: Implement info functionality
    echo "Info functionality coming soon..."
}

cmd_uninstall() {
    local name="${1:-}"
    if [[ -z "$name" ]]; then
        error_exit "Server name is required. Usage: $SCRIPT_NAME uninstall <name>"
    fi
    
    log_info "Uninstalling MCP server: $name"
    # TODO: Implement uninstall functionality
    echo "Uninstall functionality coming soon..."
}

cmd_update() {
    log_info "Updating MCP servers"
    # TODO: Implement update functionality
    echo "Update functionality coming soon..."
}

cmd_config() {
    log_info "Configuration management"
    # TODO: Implement config functionality
    echo "Config functionality coming soon..."
}

cmd_commands() {
    echo "Available commands:"
    echo "  search <query>     Search for MCP servers"
    echo "  list               List available MCP servers"
    echo "  install <name>     Install an MCP server"
    echo "  info <name>        Get information about an MCP server"
    echo "  uninstall <name>   Uninstall an MCP server"
    echo "  update             Update installed MCP servers"
    echo "  config             Manage configuration"
    echo "  commands           List available commands"
    echo "  --help, -h         Show help message"
    echo "  --version, -v      Show version information"
}

# Main function
main() {
    # Check dependencies
    check_dependencies
    
    # Initialize directories
    init_directories
    
    # Check authentication
    check_auth
    
    # Parse command line arguments
    if [[ $# -eq 0 ]]; then
        show_help
        exit 0
    fi
    
    case "${1:-}" in
        search)
            cmd_search "${2:-}"
            ;;
        list)
            cmd_list
            ;;
        install)
            cmd_install "${2:-}"
            ;;
        info)
            cmd_info "${2:-}"
            ;;
        uninstall)
            cmd_uninstall "${2:-}"
            ;;
        update)
            cmd_update
            ;;
        config)
            cmd_config
            ;;
        commands)
            cmd_commands
            ;;
        --help|-h)
            show_help
            ;;
        --version|-v)
            show_version
            ;;
        *)
            log_error "Unknown command: $1"
            log_info "Run '$SCRIPT_NAME --help' for usage information."
            exit 1
            ;;
    esac
}

# Run main function with all arguments
main "$@"
